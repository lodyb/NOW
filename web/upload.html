<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOW Media Uploader</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    .container {
      background-color: white;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="file"], textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #2980b9;
    }
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background-color: #2ecc71;
      width: 0%;
      transition: width 0.3s;
    }
    .results {
      margin-top: 20px;
    }
    .result-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .result-item.success {
      border-left: 4px solid #2ecc71;
    }
    .result-item.error {
      border-left: 4px solid #e74c3c;
    }
    .instructions {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #3498db;
    }
    /* Dropzone styles */
    .dropzone {
      border: 3px dashed #3498db;
      border-radius: 5px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s;
      background-color: #f8fafc;
    }
    .dropzone.active {
      border-color: #2ecc71;
      background-color: #eaffea;
    }
    .dropzone-text {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .dropzone-icon {
      font-size: 48px;
      color: #3498db;
      margin-bottom: 10px;
    }
    .dropzone-instructions {
      margin-top: 10px;
      text-align: left;
    }
    /* Media row styles */
    .media-list {
      margin-top: 20px;
    }
    .media-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 15px;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background-color: #f9f9f9;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s;
    }
    .media-row:nth-child(odd) {
      background-color: #f0f7ff;
    }
    .media-title-column, .media-answers-column {
      display: flex;
      flex-direction: column;
    }
    .media-title-column label, .media-answers-column label {
      margin-bottom: 5px;
    }
    .media-controls {
      display: flex;
      align-items: flex-end;
    }
    .media-controls button {
      height: fit-content;
    }
    .media-thumbnail {
      width: 120px;
      height: 80px;
      background-color: #e0e0e0;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .media-thumbnail img, .media-thumbnail video {
      max-width: 100%;
      max-height: 100%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .empty-message {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
      background-color: #f8f9fa;
      border-radius: 5px;
      margin-top: 20px;
    }
    .update-success {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      margin-top: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NOW Media Uploader</h1>
    
    <!-- Dropzone for drag and drop uploads with instructions integrated -->
    <div id="dropzone" class="dropzone">
      <div class="dropzone-icon">üìÅ</div>
      <div class="dropzone-text">Drag & drop files here</div>
      <div class="dropzone-instructions">
        <p>Upload audio or video files for the bot's media library.</p>
        <ul>
          <li>Max file size: 9MB (larger files will be compressed)</li>
          <li>New media appears at the top of the list</li>
        </ul>
      </div>
      <button type="button" id="selectFilesBtn">Select Files</button>
      <input type="file" id="files" name="files" multiple accept="audio/*,video/*" style="display:none;">
    </div>
    
    <div class="progress-container" id="progressContainer">
      <h3>Upload Progress</h3>
      <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
      </div>
      <p id="progressText">0%</p>
    </div>
    
    <div class="results" id="uploadResults">
      <h3>Upload Results</h3>
      <div id="resultsList"></div>
    </div>
    
    <!-- Media list section -->
    <div class="media-list">
      <h2>Uploaded Media</h2>
      <div id="mediaList"></div>
    </div>
  </div>

  <script>
    // DOM elements
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('files');
    const selectFilesBtn = document.getElementById('selectFilesBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsList = document.getElementById('resultsList');
    const uploadResults = document.getElementById('uploadResults');
    const mediaList = document.getElementById('mediaList');
    
    // Setup event listeners for dropzone
    dropzone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropzone.classList.add('active');
    });
    
    dropzone.addEventListener('dragleave', function() {
      dropzone.classList.remove('active');
    });
    
    dropzone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropzone.classList.remove('active');
      
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
      }
    });
    
    // Setup file input button
    selectFilesBtn.addEventListener('click', function() {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', function() {
      if (fileInput.files.length) {
        handleFileUpload();
      }
    });
    
    // Handle file upload
    function handleFileUpload() {
      if (!fileInput.files.length) {
        alert('Please select at least one file.');
        return;
      }
      
      // Create form data
      const formData = new FormData();
      
      // Add all files
      for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('files', fileInput.files[i]);
      }
      
      // Show progress container
      progressContainer.style.display = 'block';
      uploadResults.style.display = 'block';
      resultsList.innerHTML = '';
      
      // Create and send request
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = percent + '%';
          progressText.textContent = percent + '%';
        }
      });
      
      xhr.addEventListener('load', function() {
        // Handle upload response
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            
            if (response.results && response.results.length > 0) {
              // Display upload results
              response.results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${result.success ? 'success' : 'error'}`;
                
                let content = `<strong>${result.title || 'File'}</strong>: `;
                content += result.success ? 
                  `Successfully uploaded (ID: ${result.id})` : 
                  `Failed - ${result.message || 'Unknown error'}`;
                
                if (result.success) {
                  // Add edit button for successful uploads
                  content += ` <button class="edit-upload-btn" data-id="${result.id}" data-title="${result.title}">Edit Answers</button>`;
                }
                
                resultItem.innerHTML = content;
                resultsList.appendChild(resultItem);
                
                // Add event listener for the edit button if it exists
                const editBtn = resultItem.querySelector('.edit-upload-btn');
                if (editBtn) {
                  editBtn.addEventListener('click', function() {
                    const mediaId = this.dataset.id;
                    const mediaTitle = this.dataset.title;
                    createEditRow(mediaId, mediaTitle);
                  });
                }
              });
              
              // Refresh media list to show newly uploaded files
              fetchMediaList();
            } else {
              resultsList.innerHTML = '<div class="result-item error">No results returned from server.</div>';
            }
          } catch (e) {
            resultsList.innerHTML = '<div class="result-item error">Error parsing server response.</div>';
          }
        } else {
          resultsList.innerHTML = `<div class="result-item error">Upload failed with status: ${xhr.status}</div>`;
        }
        
        // Reset file input
        fileInput.value = '';
      });
      
      xhr.addEventListener('error', function() {
        resultsList.innerHTML = '<div class="result-item error">Upload failed. Network error.</div>';
        // Reset file input
        fileInput.value = '';
      });
      
      xhr.open('POST', '/api/upload', true);
      xhr.send(formData);
    }
    
    // Function to create an edit row for newly uploaded media
    function createEditRow(mediaId, mediaTitle) {
      // Create a new container for the quick edit
      const quickEditContainer = document.createElement('div');
      quickEditContainer.className = 'quick-edit-container';
      quickEditContainer.id = `quick-edit-${mediaId}`;
      
      quickEditContainer.innerHTML = `
        <h3>Quick Edit: ${mediaTitle}</h3>
        <div class="form-group">
          <label for="quick-answers-${mediaId}">Title and Alternative Answers (one per line):</label>
          <p class="help-text">First line is the title, each additional line is an alternative answer</p>
          <textarea id="quick-answers-${mediaId}" placeholder="Enter title and alternative answers (one per line)" rows="5">${mediaTitle}</textarea>
        </div>
        <div class="form-actions">
          <button class="save-quick-edit-btn" data-id="${mediaId}">Save Answers</button>
          <button class="dismiss-quick-edit-btn" data-id="${mediaId}">Dismiss</button>
        </div>
        <div class="update-success" id="quick-update-success-${mediaId}">Answers saved successfully!</div>
      `;
      
      // Insert after the result item
      const resultItem = document.querySelector(`.result-item button[data-id="${mediaId}"]`).closest('.result-item');
      resultItem.after(quickEditContainer);
      
      // Add event listeners
      quickEditContainer.querySelector('.save-quick-edit-btn').addEventListener('click', function() {
        const id = this.dataset.id;
        const answersText = document.getElementById(`quick-answers-${id}`).value.trim();
        
        updateMedia(id, answersText, function() {
          // Success callback
          const successMsg = document.getElementById(`quick-update-success-${id}`);
          successMsg.style.display = 'block';
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            successMsg.style.display = 'none';
          }, 3000);
        });
      });
      
      quickEditContainer.querySelector('.dismiss-quick-edit-btn').addEventListener('click', function() {
        const id = this.dataset.id;
        const container = document.getElementById(`quick-edit-${id}`);
        container.remove();
      });
      
      // Focus on the textarea
      document.getElementById(`quick-answers-${mediaId}`).focus();
    }
    
    // Function to fetch and display all media
    function fetchMediaList() {
      console.log('Fetching media list...');
      fetch('/api/media')
        .then(response => {
          console.log('Media API response status:', response.status);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log('Media API response data:', data);
          // Clear current list
          mediaList.innerHTML = '';
          
          if (data.success && data.media && data.media.length > 0) {
            // Sort by newest first (assuming id or createdAt is available)
            data.media.sort((a, b) => {
              // Sort by creation date if available, otherwise by ID
              if (a.createdAt && b.createdAt) {
                return new Date(b.createdAt) - new Date(a.createdAt);
              }
              return b.id - a.id;
            });
            
            // Create a row for each media item
            data.media.forEach(media => {
              const mediaRow = createMediaRow(media);
              mediaList.appendChild(mediaRow);
            });
          } else {
            // Show empty message
            mediaList.innerHTML = `
              <div class="empty-message">
                <p>No media files have been uploaded yet.</p>
                <p>Drag & drop files into the dropzone above to get started.</p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error fetching media list:', error);
          mediaList.innerHTML = `
            <div class="empty-message">
              <p>Error loading media list. Please try refreshing the page.</p>
              <p>${error.message}</p>
            </div>
          `;
        });
    }
    
    // Function to create a media row
    function createMediaRow(media) {
      // Create row element
      const row = document.createElement('div');
      row.className = 'media-row';
      row.dataset.id = media.id;
      
      // Get all answers including title as one string (one per line)
      let allAnswers = media.title || '';
      if (media.answers && media.answers.length > 0) {
        // Add any non-primary answers
        const additionalAnswers = media.answers
          .filter(a => !a.isPrimary)
          .map(a => a.answer)
          .join('\n');
        
        if (additionalAnswers) {
          allAnswers += '\n' + additionalAnswers;
        }
      }
      
      // Create row content with combined title/answers textarea
      row.innerHTML = `
        <div class="media-title-column">
          <label for="answers-${media.id}">Title and Alternative Answers (one per line):</label>
          <p class="help-text">First line is the title, each additional line is an alternative answer</p>
          <textarea id="answers-${media.id}" placeholder="Enter title and alternative answers (one per line)">${allAnswers}</textarea>
          <div class="update-success" id="update-success-${media.id}">Changes saved successfully!</div>
        </div>
        <div class="media-controls">
          <button type="button" class="update-btn" data-id="${media.id}">Save Changes</button>
        </div>
      `;
      
      // Add event listener to the update button
      row.querySelector('.update-btn').addEventListener('click', function() {
        const mediaId = this.dataset.id;
        const answersText = document.getElementById(`answers-${mediaId}`).value.trim();
        
        // Split by newline
        const lines = answersText.split('\n').filter(line => line.trim() !== '');
        
        if (lines.length === 0) {
          alert('Please provide at least a title (first line)');
          return;
        }
        
        // First line is the title, rest are answers
        const title = lines[0];
        const answers = lines.slice(1);
        
        updateMedia(mediaId, answersText);
      });
      
      return row;
    }
    
    // Function to update media
    function updateMedia(id, answersText, callback) {
      fetch(`/api/media/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          answers: answersText
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to update media: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Media update successful:', data);
        
        // Show success message if not using a callback
        if (!callback) {
          const successMsg = document.getElementById(`update-success-${id}`);
          if (successMsg) {
            successMsg.style.display = 'block';
            
            // Hide success message after 3 seconds
            setTimeout(() => {
              successMsg.style.display = 'none';
            }, 3000);
          }
        } else {
          // Use the callback if provided
          callback();
        }
        
        // Refresh the media list after updating
        fetchMediaList();
      })
      .catch(error => {
        console.error('Error updating media:', error);
        alert(`Failed to update media: ${error.message}`);
      });
    }
    
    // Initialize by loading media list when page loads
    document.addEventListener('DOMContentLoaded', fetchMediaList);
  </script>
</body>
</html>